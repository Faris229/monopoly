<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodApp | ‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2ed573; --bg: #f1f2f6; } /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå */
        body { font-family: 'Prompt', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; background: var(--primary); }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        
        .wallet-card { background: linear-gradient(135deg, #2ed573, #1dd1a1); color: white; text-align: center; padding: 25px; border-radius: 20px; margin: 20px; box-shadow: 0 10px 20px rgba(46, 213, 115, 0.3); }
        .balance { font-size: 2.5rem; font-weight: 800; }

        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 10px 0; border-top: 1px solid #eee; }
        .nav-item { flex: 1; text-align: center; color: #aaa; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 1.5rem; display: block; margin-bottom: 3px; }

        #auth-screen { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem; background: #eee; color: #555; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color:var(--primary); text-align:center;">Food Rider üõµ</h1>
        <input id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="input-box">
        <input id="pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="input-box">
        <button class="btn" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button class="btn" style="background:none; color:#555; margin-top:10px;" onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
    </div>

    <div id="app" style="display:none;">
        <div style="padding:20px; font-weight:bold; font-size:1.2rem; color:var(--primary);">Rider Console</div>

        <div id="page-home">
            <div class="wallet-card">
                <div>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏™‡∏°</div>
                <div class="balance">‡∏ø <span id="u-bal">0.00</span></div>
                <button onclick="withdraw()" style="background:rgba(255,255,255,0.2); border:none; padding:8px 20px; color:white; border-radius:20px; cursor:pointer; margin-top:10px;">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
            </div>

            <div style="padding:0 20px;">
                <h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á)</h3>
                <div id="my-jobs"></div>

                <h3 style="margin-top:30px;">‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏á (‡∏£‡∏≠‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö)</h3>
                <div id="available-jobs"></div>
            </div>
        </div>

        <div id="page-profile" style="display:none; padding:20px;">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
            <div class="card">
                <label>‡∏ä‡∏∑‡πà‡∏≠</label> <input id="p-name" class="input-box">
                <label>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label> <input id="p-plate" class="input-box">
                <label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô)</label> <input id="p-bank" class="input-box">
                <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label> <input id="p-no" class="input-box">
                <button class="btn" onclick="updateProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <button class="btn" style="background:#ff4757;" onclick="auth.signOut()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fa-solid fa-list-check"></i>‡∏á‡∏≤‡∏ô</div>
            <div class="nav-item" onclick="nav('profile', this)"><i class="fa-solid fa-user-gear"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyA2NTzJKFK3GtULDl-l2EvEH3VamDh-VZI",
            authDomain: "chat-27f96.firebaseapp.com",
            projectId: "chat-27f96",
            storageBucket: "chat-27f96.firebasestorage.app",
            messagingSenderId: "336686938010",
            appId: "1:336686938010:web:9ea0e0ddd8d93e8358ec23"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        auth.onAuthStateChanged(user => {
            if(user) {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πà‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏´‡∏°
                db.collection('users').doc(user.uid).get().then(doc => {
                    if(doc.data().role !== 'rider') {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡πÅ‡∏≠‡∏õ','‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ','error').then(()=>auth.signOut());
                    } else {
                        currentUser = user;
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('app').style.display = 'block';
                        loadData();
                        loadJobs();
                    }
                });
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // Auth
        async function login() {
            try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value); }
            catch(e) { Swal.fire('Error',e.message,'error'); }
        }

        async function register() {
            const {value: form} = await Swal.fire({
                title: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå',
                html: '<input id="sw-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•">' +
                      '<input id="sw-plate" class="swal2-input" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ">' +
                      '<input id="sw-bank" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£">' +
                      '<input id="sw-no" class="swal2-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">',
                focusConfirm: false,
                preConfirm: () => [
                    document.getElementById('sw-name').value, 
                    document.getElementById('sw-plate').value,
                    document.getElementById('sw-bank').value,
                    document.getElementById('sw-no').value
                ]
            });
            if(form) {
                const email = document.getElementById('email').value;
                const pass = document.getElementById('pass').value;
                if(!email || !pass) return Swal.fire('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô','','warning');
                
                try {
                    const c = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(c.user.uid).set({
                        email, username: form[0], plate: form[1], bankName: form[2], bankNo: form[3],
                        role: 'rider', balance: 0
                    });
                    Swal.fire('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success');
                } catch(e) { Swal.fire('Error',e.message,'error'); }
            }
        }

        // Functions
        function loadData() {
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                const d = doc.data();
                document.getElementById('u-bal').innerText = d.balance.toFixed(2);
                document.getElementById('p-name').value = d.username;
                document.getElementById('p-plate').value = d.plate;
                document.getElementById('p-bank').value = d.bankName;
                document.getElementById('p-no').value = d.bankNo;
            });
        }

        function loadJobs() {
            // Available
            db.collection('orders').where('status','==','pending').onSnapshot(snap => {
                const div = document.getElementById('available-jobs');
                div.innerHTML = '';
                if(snap.empty) div.innerHTML = '<div style="color:#aaa; text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏á</div>';
                snap.forEach(doc => {
                    const o = doc.data();
                    div.innerHTML += `
                        <div class="card">
                            <div style="font-weight:bold;">${o.menu}</div>
                            <div style="color:#666; font-size:0.9rem;">${o.address}</div>
                            <div style="margin-top:5px;">‡∏Ñ‡πà‡∏≤‡∏´‡∏¥‡πâ‡∏ß: <b style="color:var(--primary)">${o.tip} ‡∏ø</b> <span class="tag">${o.payment}</span></div>
                            <button onclick="acceptJob('${doc.id}')" class="btn" style="margin-top:10px;">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
                        </div>
                    `;
                });
            });

            // My Active Jobs
            db.collection('orders').where('riderId','==',currentUser.uid).onSnapshot(snap => {
                const div = document.getElementById('my-jobs');
                div.innerHTML = '';
                snap.forEach(doc => {
                    const o = doc.data();
                    if(o.status === 'completed') return;

                    let actionBtn = '';
                    if(o.status === 'accepted') actionBtn = `<button onclick="updateStatus('${doc.id}','buying')" class="btn" style="background:#ffa502">‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô/‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>`;
                    else if(o.status === 'buying') actionBtn = `<button onclick="updateStatus('${doc.id}','delivering')" class="btn" style="background:#3742fa">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÑ‡∏õ‡∏™‡πà‡∏á</button>`;
                    else actionBtn = `<div style="text-align:center; color:green; font-weight:bold;">‡∏£‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á...</div>`;

                    div.innerHTML += `
                        <div class="card" style="border-left:5px solid var(--primary)">
                            <div style="font-weight:bold;">${o.menu}</div>
                            <div style="color:#666;">${o.address}</div>
                            <div style="margin:10px 0;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${o.status.toUpperCase()}</b></div>
                            ${actionBtn}
                        </div>
                    `;
                });
            });
        }

        async function acceptJob(id) {
            await db.collection('orders').doc(id).update({ riderId: currentUser.uid, status: 'accepted' });
            Swal.fire('‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß','‡∏£‡∏µ‡∏ö‡πÑ‡∏õ‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢!','success');
        }

        async function updateStatus(id, st) {
            await db.collection('orders').doc(id).update({ status: st });
        }

        async function withdraw() {
            const {value:n} = await Swal.fire({title:'‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', text:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£', input:'number'});
            if(n) {
                const u = await db.collection('users').doc(currentUser.uid).get();
                if(u.data().balance < n) return Swal.fire('‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠','','error');
                
                await db.collection('transactions').add({
                    uid: currentUser.uid, type: 'withdraw', amount: parseFloat(n), status: 'pending'
                });
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡∏ñ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß','‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ','success');
            }
        }

        async function updateProfile() {
            await db.collection('users').doc(currentUser.uid).update({
                username: document.getElementById('p-name').value,
                plate: document.getElementById('p-plate').value,
                bankName: document.getElementById('p-bank').value,
                bankNo: document.getElementById('p-no').value
            });
            Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','','success');
        }

        function nav(page, el) {
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('page-home').style.display = page==='home'?'block':'none';
            document.getElementById('page-profile').style.display = page==='profile'?'block':'none';
        }
    </script>
</body>
</html>
